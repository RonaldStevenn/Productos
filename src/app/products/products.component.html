<div class="container-fluid mt-4">

  <!-- BARRA DE NAVEGACI√ìN PRINCIPAL -->
  <div class="card shadow-sm mb-4 border-0">
    <div class="card-body d-flex justify-content-start align-items-center gap-2 flex-wrap">
      <h5 class="mb-0 me-3 fw-bold">Vistas</h5>
      <button class="btn" [class.btn-primary]="vista === 'listaProductos'" [class.btn-outline-primary]="vista !== 'listaProductos'" (click)="cambiarVista('listaProductos')">
        <i class="bi bi-box-seam-fill me-2"></i>Productos
      </button>
      <button class="btn" [class.btn-primary]="vista === 'listaProveedores'" [class.btn-outline-primary]="vista !== 'listaProveedores'" (click)="cambiarVista('listaProveedores')">
        <i class="bi bi-truck me-2"></i>Proveedores
      </button>
      <button class="btn" [class.btn-info]="vista === 'kardex'" [class.btn-outline-info]="vista !== 'kardex'" (click)="verKardex()">
        <i class="bi bi-clock-history me-2"></i>Ver Historial
      </button>

      <!-- BOTONES DE ACCIONES -->
      <div class="ms-auto d-flex gap-2">
        <button class="btn btn-success" (click)="exportarExcel()">
          <i class="bi bi-file-earmark-excel-fill me-2"></i>Exportar Excel
        </button>
        <button class="btn btn-outline-secondary" (click)="recargar()" [disabled]="isLoading">
          <i class="bi bi-arrow-clockwise me-1" [class.spinner-border]="isLoading" [class.spinner-border-sm]="isLoading"></i>
          <span *ngIf="!isLoading">Recargar</span>
        </button>
      </div>
    </div>
  </div>

  <!-- CONTENEDOR DE VISTAS -->
  <div [ngSwitch]="vista">

    <!-- VISTA: LISTA DE PRODUCTOS -->
    <ng-container *ngSwitchCase="'listaProductos'">
      <!-- KPIs DASHBOARD -->
      <div class="row mb-4 g-4">
        <div class="col-md-4">
          <div class="card text-white bg-primary shadow-lg h-100">
            <div class="card-body d-flex align-items-center">
              <i class="bi bi-box-seam-fill display-4 me-3"></i>
              <div>
                <div class="fs-5">Total Productos</div>
                <div class="fs-2 fw-bold">{{ totalProductos$ | async }}</div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-white bg-success shadow-lg h-100">
            <div class="card-body d-flex align-items-center">
              <i class="bi bi-cash-stack display-4 me-3"></i>
              <div>
                <div class="fs-5">Valor Inventario</div>
                <div class="fs-2 fw-bold">{{ valorInventario$ | async | currency:'USD':'symbol':'1.0-0' }}</div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card text-dark bg-warning shadow-lg h-100">
            <div class="card-body d-flex align-items-center">
              <i class="bi bi-exclamation-triangle-fill display-4 me-3"></i>
              <div>
                <div class="fs-5">Alertas Stock</div>
                <div class="fs-2 fw-bold">{{ stockBajo$ | async }} <span class="fs-6">productos</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TABLA DE PRODUCTOS -->
      <div class="card shadow-lg border-0 rounded-3">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
          <h2 class="mb-0"><i class="bi bi-collection-fill me-2"></i>Inventario</h2>
          <button class="btn btn-primary" (click)="mostrarFormularioProducto()">
            <i class="bi bi-plus-circle-fill me-2"></i>Nuevo Producto
          </button>
        </div>
        <div class="card-body">
          <!-- Barra de B√∫squeda -->
          <div class="input-group mb-3">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" placeholder="Buscar por nombre o categor√≠a..." [formControl]="buscador">
          </div>

          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
              <thead class="table-dark">
                <tr>
                  <th scope="col" style="width: 5%;">Imagen</th>
                  <th>Producto</th>
                  <th>Categor√≠a</th>
                  <th>Proveedor</th>
                  <th>Stock</th>
                  <th>Costo</th>
                  <th>Venta</th>
                  <th>Ganancia Total</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody *ngIf="(productos$ | async) as productos; else noDataProductos">
                <tr *ngFor="let producto of productos">
                  <td>
                    <img *ngIf="producto.imagenUrl; else noImagen" [src]="producto.imagenUrl" [alt]="producto.nombre" class="rounded-circle" width="40" height="40" style="object-fit: cover;">
                    <ng-template #noImagen>
                      <div class="d-flex align-items-center justify-content-center bg-light rounded-circle" style="width: 40px; height: 40px;">
                        <i class="bi bi-image" style="font-size: 1.2rem; color: #6c757d;"></i>
                      </div>
                    </ng-template>
                  </td>
                  <td><strong>{{ producto.nombre }}</strong></td>
                  <td>{{ producto.categoria }}</td>
                  <td>{{ getNombreProveedor(producto.proveedorId, (proveedores$ | async)) }}</td>
                  <td>
                    <span class="badge fs-6 rounded-pill" [ngClass]="{
                      'bg-danger text-white': producto.stock < 5,
                      'bg-warning text-dark': producto.stock >= 5 && producto.stock <= 10,
                      'bg-success text-white': producto.stock > 10
                    }">{{ producto.stock }}</span>
                  </td>
                  <td>{{ producto.costoCompra | currency }}</td>
                  <td>{{ producto.precioVenta | currency }}</td>
                  <td>
                    <span class="badge fs-6" [ngClass]="{'bg-success': (producto.ganancia ?? 0) > 0, 'bg-danger': (producto.ganancia ?? 0) <= 0}">
                      {{ producto.ganancia | currency }}
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary me-2" (click)="mostrarFormularioProducto(producto)" title="Editar">
                      <i class="bi bi-pencil-fill"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" (click)="borrarProducto(producto.id)" title="Eliminar">
                      <i class="bi bi-trash-fill"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
              <ng-template #noDataProductos>
                <tr>
                  <td colspan="9" class="text-center p-5">
                    <div *ngIf="buscador.value; else sinProductos">
                        <p class="h4">No se encontraron productos para "<strong>{{ buscador.value }}</strong>".</p>
                    </div>
                    <ng-template #sinProductos>
                        <p class="h4">No hay productos en el inventario.</p>
                    </ng-template>
                  </td>
                </tr>
              </ng-template>
            </table>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- VISTA: FORMULARIO DE PRODUCTO -->
    <ng-container *ngSwitchCase="'formProducto'">
      <div class="card shadow-lg border-0 rounded-3">
        <div class="card-header bg-primary text-white">
          <h2 class="mb-0">{{ productoEnEdicion ? '‚úèÔ∏è Editar Producto' : 'üì¶ Nuevo Producto' }}</h2>
        </div>
        <div class="card-body p-4">
          <form [formGroup]="productoForm" (ngSubmit)="guardarProducto()" novalidate>
            <div class="row">
              <div class="col-md-8"><label for="nombre" class="form-label">Nombre del Producto</label><input type="text" id="nombre" class="form-control" formControlName="nombre"></div>
              <div class="col-md-4"><label for="categoria" class="form-label">Categor√≠a</label><input type="text" id="categoria" class="form-control" formControlName="categoria"></div>
            </div>
             <div class="row mt-3">
              <div class="col-12">
                <label for="imagenUrl" class="form-label">URL de Imagen <span class="text-muted">(Opcional)</span></label>
                <input type="url" id="imagenUrl" class="form-control" formControlName="imagenUrl" placeholder="https://ejemplo.com/imagen.png">
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-md-12"><label for="proveedorId" class="form-label">Proveedor</label>
                <select id="proveedorId" class="form-select" formControlName="proveedorId">
                  <option value="" disabled>Selecciona un proveedor...</option>
                  <option *ngFor="let p of proveedores$ | async" [value]="p.id">{{ p.nombre }}</option>
                </select>
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-md-4"><label for="stock" class="form-label">Stock</label><input type="number" id="stock" class="form-control" formControlName="stock"></div>
              <div class="col-md-4"><label for="costoCompra" class="form-label">Costo de Compra</label><input type="number" id="costoCompra" class="form-control" formControlName="costoCompra"></div>
              <div class="col-md-4"><label for="precioVenta" class="form-label">Precio de Venta</label><input type="number" id="precioVenta" class="form-control" formControlName="precioVenta"></div>
            </div>
            <hr class="my-4">
            <div class="d-flex justify-content-end">
              <button type="button" class="btn btn-secondary me-2" (click)="cambiarVista('listaProductos')"><i class="bi bi-x-lg me-2"></i>Cancelar</button>
              <button type="submit" class="btn btn-primary" [disabled]="productoForm.invalid"><i class="bi bi-check-lg me-2"></i>Guardar</button>
            </div>
          </form>
        </div>
      </div>
    </ng-container>

    <!-- VISTA: GESTI√ìN DE PROVEEDORES -->
    <ng-container *ngSwitchCase="'listaProveedores'">
      <div class="row">
        <!-- Columna del Formulario -->
        <div class="col-lg-4">
          <div class="card shadow-lg border-0 rounded-3">
            <div class="card-header bg-dark text-white">
              <h2 class="mb-0">{{ proveedorEnEdicion ? '‚úèÔ∏è Editar Proveedor' : 'üöö Nuevo Proveedor' }}</h2>
            </div>
            <div class="card-body p-4">
              <form [formGroup]="proveedorForm" (ngSubmit)="guardarProveedor()" novalidate>
                <div class="mb-3">
                  <label for="provNombre" class="form-label">Nombre <span class="text-danger">*</span></label>
                  <input type="text" id="provNombre" class="form-control" formControlName="nombre">
                </div>
                <div class="mb-3">
                  <label for="provTelefono" class="form-label">Tel√©fono <span class="text-muted">(Opcional)</span></label>
                  <input type="text" id="provTelefono" class="form-control" formControlName="telefono">
                </div>
                <div class="mb-3">
                  <label for="provWeb" class="form-label">Sitio Web <span class="text-muted">(Opcional)</span></label>
                  <input type="text" id="provWeb" class="form-control" formControlName="web" placeholder="ejemplo.com">
                </div>
                <hr class="my-4">
                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-primary" [disabled]="proveedorForm.invalid">
                    <i class="bi bi-check-lg me-2"></i> {{ proveedorEnEdicion ? 'Actualizar' : 'Guardar' }}
                  </button>
                  <button type="button" class="btn btn-secondary" *ngIf="proveedorEnEdicion" (click)="cancelarEdicionProveedor()">
                    <i class="bi bi-x-lg me-2"></i>Cancelar Edici√≥n
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <!-- Columna de la Tabla -->
        <div class="col-lg-8">
          <div class="card shadow-lg border-0 rounded-3">
             <div class="card-header bg-dark text-white"><h2 class="mb-0">Directorio de Proveedores</h2></div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                  <thead class="table-dark">
                    <tr>
                      <th>Nombre</th>
                      <th>Tel√©fono</th>
                      <th>Web</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody *ngIf="(proveedores$ | async) as proveedores; else noDataProveedores">
                    <tr *ngFor="let proveedor of proveedores">
                      <td><strong>{{ proveedor.nombre }}</strong></td>
                      <td>{{ proveedor.telefono || 'N/A' }}</td>
                      <td><a *ngIf="proveedor.web" [href]="'http://' + proveedor.web" target="_blank">{{ proveedor.web }}</a> <span *ngIf="!proveedor.web">N/A</span></td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary me-2" (click)="mostrarFormularioProveedor(proveedor)" title="Editar">
                          <i class="bi bi-pencil-fill"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" (click)="borrarProveedor(proveedor.id)" title="Eliminar">
                          <i class="bi bi-trash-fill"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                   <ng-template #noDataProveedores>
                    <tr>
                      <td colspan="4" class="text-center p-5">
                        <p class="h4">No hay proveedores registrados.</p>
                      </td>
                    </tr>
                  </ng-template>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- VISTA: HISTORIAL/KARDEX -->
    <ng-container *ngSwitchCase="'kardex'">
       <div class="card shadow-lg border-0 rounded-3">
        <div class="card-header bg-info text-dark d-flex justify-content-between align-items-center flex-wrap">
          <h2 class="mb-0"><i class="bi bi-clock-history me-2"></i>Historial de Movimientos</h2>
          <div>
            <button class="btn btn-danger me-2" (click)="borrarHistorial()">
              <i class="bi bi-trash3-fill me-2"></i>Limpiar Historial
            </button>
            <button class="btn btn-secondary" (click)="cambiarVista('listaProductos')">
              <i class="bi bi-arrow-left-circle-fill me-2"></i>Volver
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
              <thead class="table-dark">
                <tr>
                  <th scope="col">Fecha y Hora</th>
                  <th scope="col">Tipo</th>
                  <th scope="col">Descripci√≥n</th>
                  <th scope="col">Cantidad</th>
                </tr>
              </thead>
              <tbody *ngIf="(movimientos$ | async) as movimientos; else noDataMovimientos">
                <tr *ngFor="let m of movimientos" [class.table-success]="m.tipo === 'ENTRADA'" [class.table-danger]="m.tipo === 'SALIDA'" [class.table-secondary]="m.tipo === 'SISTEMA'">
                  <td>{{ m.fecha | date:'short' }}</td>
                  <td>
                    <span class="badge" [ngClass]="{
                      'bg-success': m.tipo === 'ENTRADA',
                      'bg-danger': m.tipo === 'SALIDA',
                      'bg-dark': m.tipo === 'SISTEMA'
                    }">{{ m.tipo }}</span>
                  </td>
                  <td>{{ m.descripcion }}</td>
                  <td><strong>{{ m.cantidad ?? 'N/A' }}</strong></td>
                </tr>
              </tbody>
              <ng-template #noDataMovimientos>
                <tr>
                  <td colspan="4" class="text-center p-5">
                    <p class="h4">No hay movimientos registrados todav√≠a.</p>
                  </td>
                </tr>
              </ng-template>
            </table>
          </div>
        </div>
      </div>
    </ng-container>

  </div>
</div>